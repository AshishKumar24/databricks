import json
from databricks.sdk import WorkspaceClient

def get_workspace_client() -> WorkspaceClient:
    """Initializes and returns the Databricks WorkspaceClient."""
    w = WorkspaceClient()
    # Note: WorkspaceClient usually handles auth automatically, 
    # but here is your token retrieval if your specific environment requires it elsewhere.
    token = dbutils.notebook.entry_point.getDbutils().notebook().getContext().apiToken().get()
    print(f"Token retrieved: {token[:10]}...") 
    return w

def get_first_space_id(w: WorkspaceClient) -> str:
    """Fetches the list of Genie spaces and returns the ID of the first one."""
    response = w.api_client.do("GET", "/api/2.0/genie/spaces")
    space_id = response['spaces'][0]['space_id']
    print(f"Target Space ID: {space_id}")
    return space_id

def get_space_details(w: WorkspaceClient, space_id: str) -> tuple:
    """Fetches space details and parses the serialized_space string into a dictionary."""
    response = w.api_client.do(
        "GET", 
        f"/api/2.0/genie/spaces/{space_id}", 
        query={"include_serialized_space": "true"}
    )
    # Parse the nested string into a usable Python dictionary
    serialized_space_dict = json.loads(response['serialized_space'])
    
    return response, serialized_space_dict

def update_column_description(serialized_space: dict, table_target: str, column_target: str, new_desc: str) -> dict:
    """Finds the target table and column, and appends the new description."""
    tables_list = serialized_space.get("data_sources", {}).get("tables", [])

    for table in tables_list:
        if table.get('identifier') == table_target:
            for column in table.get('column_configs', []):
                if column.get('column_name') == column_target:
                    
                    # cleanly append or create the list in one line
                    column.setdefault('description', []).append(new_desc)
                    print(f"Updated description for {column_target}: {column['description']}")
                    
    # Because dictionaries are modified in-place in Python, 
    # serialized_space is already fully updated. We just return it.
    return serialized_space

def patch_genie_space(w: WorkspaceClient, space_id: str, original_response: dict, updated_serialized_space: dict):
    """Packages the updated dictionary back into a string and sends the PATCH request."""
    # Convert the modified dict back into a "Scalar String"
    original_response['serialized_space'] = json.dumps(updated_serialized_space)
    
    # Send the PATCH request
    # Note: Passing the dictionary directly to 'body=' is correct; 
    # the api_client will handle converting the outer payload to JSON.
    patch_response = w.api_client.do(
        "PATCH", 
        f"/api/2.0/genie/spaces/{space_id}", 
        body=original_response
    )
    print("Space updated successfully!")
    return patch_response

def main():
    # 1. Setup target variables
    TABLE_TARGET = 'samples.bakehouse.sales_customers'
    COLUMN_TARGET = 'customerID'
    DESCRIPTION_TO_ADD = "Date of Review"

    # 2. Execute flow
    w = get_workspace_client()
    space_id = get_first_space_id(w)
    
    # Fetch data
    raw_response, serialized_space_dict = get_space_details(w, space_id)
    
    # Modify data
    updated_space_dict = update_column_description(
        serialized_space=serialized_space_dict, 
        table_target=TABLE_TARGET, 
        column_target=COLUMN_TARGET, 
        new_desc=DESCRIPTION_TO_ADD
    )
    
    # Save data
    patch_genie_space(w, space_id, raw_response, updated_space_dict)

# Run the script
if __name__ == "__main__":
    main()
